<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="google-site-verification" content="vy14mO9wf2bjKiZs8BIxCFXKJDP40DqGTqiwxscMctw" />
<title>Promises/Deferred trong AngularJS &#8211; THAPSANG.NET</title>
<meta name="description" content="Tìm hiểu về Promises và Deferred trong AngularJs.">
<meta name="keywords" content="promise, angularjs">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://thapsang.net/images/my-candle.png">
<meta name="twitter:title" content="Promises/Deferred trong AngularJS">
<meta name="twitter:description" content="Tìm hiểu về Promises và Deferred trong AngularJs.">
<meta name="twitter:creator" content="@taly2808">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Promises/Deferred trong AngularJS">
<meta property="og:description" content="Tìm hiểu về Promises và Deferred trong AngularJs.">
<meta property="og:url" content="http://thapsang.net/angularjs/promises-deferred-trong-angularjs">
<meta property="og:site_name" content="THAPSANG.NET">
<meta property="og:image" content="http://thapsang.net/images/my-candle.png">





<link rel="canonical" href="http://thapsang.net/angularjs/promises-deferred-trong-angularjs">
<link href="http://thapsang.net/feed.xml" type="application/atom+xml" rel="alternate" title="THAPSANG.NET Feed">
<link rel="author" href="https://plus.google.com/+TaLy2808?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="stylesheet" type="text/css" href="http://thapsang.net/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="http://thapsang.net/assets/css/style.css" />

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search...">
        <i class="icon-remove-sign"></i>
        <ul class="search-results post-list"></ul><!-- /.search-results -->
    </div><!-- /.search-form -->
</div><!-- ./search-wrapper -->




<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://thapsang.net/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://thapsang.net/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://thapsang.net/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://thapsang.net/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://thapsang.net/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://thapsang.net/images/apple-touch-icon-144x144-precomposed.png">

</head>
<body class="post-template" itemscope itemtype="http://schema.org/WebPage">  
<div id="fade"></div>
<a id="slide" class="animated fade"></a>
<aside id="sidebar">
    <nav id="navigation">
    <h2>MENU</h2>
    <hr>

            <li>
                    <a href="http://thapsang.net/">Trang bìa</a>
                 </li>

            <li>
                    <a href="http://thapsang.net/categories">Danh mục</a>
                 </li>

            <li>
                    <a href="http://thapsang.net/tags"><i class="icon-tag"></i> Tags</a>
                 </li>

            <li>
                    <a href="http://thapsang.net/about">Giới thiệu</a>
                 </li>
            
           <li><a href="https://feedburner.google.com/fb/a/mailverify?uri=thapsangnet/taly2808&amp;loc=en_US" title="Atom/RSS feed" target="_blank"><i class="icon-rss"></i> Feed</a></li>
    </nav>
    
    
</aside>

<header id="masthead" class="blog-background overlay align-center align-middle animated from-bottom"  style="background-image: url(http://thapsang.net/images/picture-2.jpg)" itemscope itemtype="http://schema.org/Organization">


    <button class="menu-button animated fade dosearch">
        <i class="icon-search"></i>
    </button>


    <div class="inner">
        <div class="container">
            <a class="brand" href="http://thapsang.net/" role="banner" itemprop="url">

                <img itemprop="logo" src="http://thapsang.net/images/my-candle.png" alt="THAPSANG.NET Logo" />

            <h1 class="blog-title light" itemprop="name">
                THAPSANG.NET
            </h1>
                
            </a>
        </div>
    </div>
    
    
    <div class="decor-wrapper">
        <svg id="header-decor" class="decor bottom" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" preserveAspectRatio="none">
            <path class="large left" d="M0 0 L50 50 L0 100" fill="rgba(255,255,255, .1)"></path>
            <path class="large right" d="M100 0 L50 50 L100 100" fill="rgba(255,255,255, .1)"></path>

            <path class="medium left" d="M0 100 L50 50 L0 33.3" fill="rgba(255,255,255, .3)"></path>
            <path class="medium right" d="M100 100 L50 50 L100 33.3" fill="rgba(255,255,255, .3)"></path>

            <path class="small left" d="M0 100 L50 50 L0 66.6" fill="rgba(255,255,255, .5)"></path>
            <path class="small right" d="M100 100 L50 50 L100 66.6" fill="rgba(255,255,255, .5)"></path>

            <path d="M0 99.9 L50 49.9 L100 99.9 L0 99.9" fill="rgba(255,255,255, 1)"></path>

            <path d="M48 52 L50 49 L52 52 L48 52" fill="rgba(255,255,255, 1)"></path>

        </svg>
    </div>
    
</header>

<div id="main" class="content" role="main" itemprop="mainContentOfPage" itemscope itemtype="http://schema.org/Blog">
    <div class="container">
        <div class="row">
            <article class="post col-md-10 col-md-offset-1 hentry" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
            
            
            
            
            
                    <header class="post-header entry-header">
                    
                        
                        <h1 class="post-title text-center hyper lighter bordered-bottom entry-title" itemprop="headline">Promises/Deferred trong AngularJS</h1>
                        
                        <div class="cursive" style="color: #000; font-style:italic;">Tìm hiểu về Promises và Deferred trong AngularJs.</div>
                        <div class="post-info text-center small">
                            <span class="entry-date date published updated"><time datetime="2014-10-30T00:00:00+07:00" class="post-time" itemprop="datePublished">30 Oct 2014</time><span>
                            in <span class="post-tags"><a href="http://thapsang.net/categories/index.html#angularjs" data-toggle="tooltip" title="Other posts from the Angularjs category" rel="tag">Angularjs</a></span>&nbsp;<span class="post-tags"><i class="icon-time"></i>&nbsp;<span class="time">17.78</span> minutes read</span>
                        </div>
                    </header>
                    <div class="post-body bordered-bottom" itemprop="description">
                        
                        <p>Promises là một tính năng chính (a core feature) của AngularJS. Có thể bạn chưa biết hoặc chưa hiểu về promise, nhưng nếu bạn làm việc với AngularJS thì gần như chắc chắn rằng bạn sẽ làm việc với promise. Trong bài viết này, chúng ta sẽ tìm hiểu vậy Promise là gì, chúng được sử dụng ở đâu? Cách thức nó làm việc như thế nào?</p>

<section>
  <header>
    <h2>Nội dung</h2>
  </header>
<div id="drawer">
<ul id="markdown-toc">
  <li><a href="#promise-l-g">Promise là gì?</a></li>
  <li><a href="#promise-lm-vic-nh-th-no">Promise làm việc như thế nào?</a></li>
  <li><a href="#v-d-n-gin">Ví dụ đơn giản</a></li>
  <li><a href="#chaining-promise">Chaining Promise</a></li>
  <li><a href="#parallel-promises">Parallel Promises</a></li>
  <li><a href="#ti-liu-tham-kho">Tài liệu tham khảo</a></li>
</ul>

  </div>
</section>

<h2 id="promise-l-g">Promise là gì?</h2>

<blockquote>
  <p>Promise là một cơ chế cho phép bạn trì hoãn một hành động hoặc một chuỗi các hành động đã được nêu ra. Một promise đại diện cho kết quả sau cùng của một hành động. Chúng ta có thể sử dụng một promise để xác định phải làm gì khi hành động cho dù kết quả cuối cùng của promise là thành công hay thất bại. Và promise sử dụng để xử lý các sự kiện không đồng bộ.</p>
</blockquote>

<h2 id="promise-lm-vic-nh-th-no">Promise làm việc như thế nào?</h2>

<p>Khái niệm dưới đây về Promise khá đơn giản, nó có 2 thành phần:</p>

<ul>
  <li>Deferred: đại diện cho <strong>một công việc</strong> chưa được thực hiện, và</li>
  <li>Promise: thể hiện cho <strong>kết quả</strong> từ công việc đó (Deferred).</li>
</ul>

<figure>
	<img src="https://docs.google.com/drawings/d/1112lp5doFi8EBtTZoJ3p7LESacWkReM7YsWQWWB0NrA/pub?w=830&amp;h=631" />
</figure>
<p><small>source: <a href="http://blog.mediumequalsmessage.com/promise-deferred-objects-in-javascript-pt1-theory-and-semantics">Promise &amp; Deferred objects in JavaScript Pt.1: Theory and Semantics.</a></small> </p>

<p>Về cơ bản, chúng ta sử dụng <strong>Deferred</strong> như là một đối tượng thông tin liên lạc để báo hiệu sự bắt đầu, tiến trình xử lý và hoàn thành công việc.</p>

<p>Một <strong>Promise</strong> lần lượt là một đối tượng đầu ra chứa kết quả từ <strong>Deferred</strong>. Nó có một trạng thái (State) nhất định (đang chờ xử lý - pending, hoàn thành - fulfilled, bị từ chối - rejected) và bộ xử lý (Handlers) hoặc các hàm gọi lại (callback functions) sẽ được gọi một lần khi một promise được giải quyết, bị từ chối hoặc cập nhật tiến trình xử lý.</p>

<p>Trong Angular, các promises được tạo ra bằng <a href="https://docs.angularjs.org/api/ng/service/$q">$q service</a>. Lý do dịch vụ được đặt tên là $q là do việc thực hiện promises trong AngularJS dựa trên cơ chế promise của Kris Kowal có tên là thư viện <strong>Q</strong>. Bạn có thể xem thêm thông tin về thư viện Q tại <a href="https://github.com/kriskowal/q">https://github.com/kriskowal/q</a>. Promises cũng được trả lại từ vài dịch vụ khác nữa của AngularJS như <a href="https://docs.angularjs.org/api/ng/service/$http">$http</a>, <a href="https://docs.angularjs.org/api/ng/service/$timeout">$timeout</a>, <a href="https://docs.angularjs.org/api/ngRoute/service/$route">$route</a>, <a href="https://docs.angularjs.org/api/ngResource/service/$resource">$resoure</a>.</p>

<p>$q thực thi tất cả các phương thức Deferred/Promise được mô tả ở trên, cộng thêm một số phương thức của của riêng nó: <em>$q.defer()</em> - tạo mới một đối tượng Deferred , <em>$q.all()</em> - cho phép bạn chờ nhiều promises để giải quyết, và phương thức <em>$q.when()</em>, <em>$q.reject()</em>.</p>

<p><strong>$q.defer()</strong> trả lại một đối tượng Deferred, bao gồm các phương thức <em>resolve(), reject(), notify()</em>. Deferred có một thuộc tính promise, thuộc tính này là một đối tượng promise có thể được truyền khắp ứng dụng.</p>

<p>Đối tượng promise có 3 phương thức khác: <em>then(), catch(), finally()</em></p>

<ul>
  <li><em>then(successCallback, errorCallback, notifyCallback)</em>: lấy 3 callbacks làm tham số, một cho khi promise thành công, một cho khi promise thất bại, một cho thông báo của promise.</li>
  <li><em>catch(errorCallback)</em>: đây là cách viết tắt của phương thức <code>promise.then(null, errorCallback)</code>, có thể được sử dụng để có một chức năng tập trung, được gọi khi bất kì promise trong chuỗi promise thất bại.</li>
  <li><em>finally(callback)</em>: phương thức này luôn luôn được gọi, bất kể promise thành công hay thất bại. Nó rất hữu ích để giải phóng tài nguyên hoặc dọn dẹp một số thứ không cần thiết (giống như đóng kết nối tới database, shutting server down). Xem bản mô tả <a href="https://github.com/kriskowal/q/wiki/API-Reference#promisefinallycallback">chi tiết kỹ thuật đầy đủ</a> để có thêm thông tin.</li>
</ul>

<h2 id="v-d-n-gin">Ví dụ đơn giản</h2>

<p>Trong ví dụ này, chúng ta sẽ tạo ra một dịch vụ để lấy tên người dùng. Trong service, chúng ta thiết lập rằng lần đầu tiên chúng ta lấy tên từ server, các lần sau chúng ta sẽ trả lại từ bộ nhớ cache. Điều này có nghĩa là chúng ta phải xử lý với trường hợp không đồng bộ (lấy dữ liệu từ server) và trường hợp đồng bộ thông thường (lấy dữ liệu từ cache).</p>

<p>Đầu tiên, chúng ta tạo ra một service, nó có một trường <em>name</em>, giá trị ban đầu là null.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">&#39;NameService&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$http</span><span class="p">,</span> <span class="nx">$q</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">//  Create a class that represents our name service.</span>
  <span class="kd">function</span> <span class="nx">NameService</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="c1">//  Initially the name is unknown....</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></code></pre></div>

<p>Bây giờ, trong hàm <code>getName()</code>, chúng ta tạo một đối tượng <code>deferred</code> sử dụng $q service. Đối tượng này chứa promise mà chúng ta sẽ trả về.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">self</span><span class="p">.</span><span class="nx">getName</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Create a deferred operation.</span>
  <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span></code></pre></div>

<p>Nếu chúng ta đã có <code>name</code>, chúng ta có thể <code>resolve</code> đối tượng deferred ngay lập tức:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">name</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; (from Cache!)&quot;</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<p>Tiếp đó, chúng ta sẽ xử lý trường hợp khi chưa có <code>name</code>:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">else</span> <span class="p">{</span>
  <span class="c1">//  Get the name from the server.</span>
  <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/my/name/&#39;</span><span class="p">)</span>
     <span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">self</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
       <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; (from Server!)&quot;</span><span class="p">);</span>
     <span class="p">})</span>
     <span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
     <span class="p">});</span>
 <span class="p">}</span></code></pre></div>

<p>Ở đây, chúng ta sử dụng <code>$http</code> service, và <code>success</code>, <code>error</code> là 2 function đặc biệt được thêm vào promise do <code>$http</code> cung cấp - thông thường chúng ta sử dụng hàm <code>then</code> với promise.</p>

<p>Do đó, nếu chúng ta nhận được dữ liệu từ server, chúng ta có thể <code>resolve</code> promise với giá trị trả về. Ngược lại, nếu request bị lỗi, chúng ta sẽ <code>reject</code> promise.</p>

<p>Cuối cùng, chúng ta trả lại promise mà chúng ta đã khởi tạo với <code>deferred</code>:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>Demo với JSFiddle:</p>

<iframe width="100%" height="300" src="http://jsfiddle.net/taly2808/f5826s0k/2/embedded/js,html,result" allowfullscreen="allowfullscreen" frameborder="0"></iframe>

<p>Chúng ta sẽ sử dụng dịch vụ này trong controller như sau:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;MainController&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">NameService</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">//  We have a name on the code, but it&#39;s initially empty...</span>
  <span class="nx">$scope</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

  <span class="c1">//  We have a function on the scope that can update the name.</span>
  <span class="nx">$scope</span><span class="p">.</span><span class="nx">updateName</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">NameService</span><span class="p">.</span><span class="nx">getName</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span>
      <span class="cm">/* success function */</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$scope</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
      <span class="p">},</span>
      <span class="cm">/* error function */</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Failed to get the name, result is &quot;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">);</span> 
      <span class="p">});</span>
  <span class="p">};</span>
<span class="p">});</span></code></pre></div>

<p>Trong đoạn mã trên, chúng ta thấy có chút khác biệt, đó là sự xuất hiện của phương thức <code>then</code> với tham số thứ nhất là successCallback và tham số thứ hai là errorCallback. Chúng ta cần nhớ rằng: </p>

<blockquote>
  <p>AngularJS thêm các hàm <code>success</code>, <code>error</code> vào promise khi sử dụng <code>$http</code> service và <code>$resource</code> service. Chúng không phải là chuẩn và chúng ta sẽ không tìm thấy chúng trong các promise khác.</p>
</blockquote>

<h2 id="chaining-promise">Chaining Promise</h2>

<p>Phương thức <code>then</code> trả lại một promise. Điều tuyệt vời của Promise API đó là chúng ta có thể đính kèm nhiều bộ xử lý (then()) cho một promise. Nói cách khác, chúng ta có thể xâu chuỗi các promise thành một khối logic ngắn gọn được thực thi tại các thời điểm thích hợp mà không cần sử dụng lồng nhau.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">promise</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">doSomething</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">doSomethingElse</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">doSomethingMore</span><span class="p">)</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">logError</span><span class="p">);</span></code></pre></div>

<p>Ví dụ, chúng ta cần lấy ra tên của user từ phía backend, nhưng chúng ta phải sử dụng các request độc lập để lấy ra thông tin của user và sau đó lấy ra quyền hạn truy cập trên ứng dụng của user:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">details</span> <span class="p">{</span>  
   <span class="nx">username</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
   <span class="nx">profile</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
   <span class="nx">permissions</span><span class="o">:</span> <span class="kc">null</span>
<span class="p">};</span>

<span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/user/name&#39;</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
     <span class="c1">// Store the username, get the profile.</span>
     <span class="nx">details</span><span class="p">.</span><span class="nx">username</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
     <span class="k">return</span> <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/profile/&#39;</span> <span class="o">+</span> <span class="nx">details</span><span class="p">.</span><span class="nx">username</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//  Store the profile, now get the permissions.</span>
    <span class="nx">details</span><span class="p">.</span><span class="nx">profile</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/security/&#39;</span> <span class="o">+</span> <span class="nx">details</span><span class="p">.</span><span class="nx">username</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//  Store the permissions</span>
    <span class="nx">details</span><span class="p">.</span><span class="nx">permissions</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The full user details are: &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">details</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;An error occured: &quot;</span> <span class="o">+</span> <span class="nx">error</span><span class="p">);</span>
  <span class="p">});</span></code></pre></div>

<p>Như vậy, chúng ta có một chuỗi các lời gọi không đồng bộ được phối hợp với nhau mà không cần sử dụng các callbacks lồng nhau.</p>

<blockquote>
  <ul>
    <li>Chuỗi các promises (promise chains) sẽ gọi hàm <code>then</code> tiếp theo trong chuỗi với giá trị được trả lại của hàm <code>then</code> trước đó (hoặc <em>undefined</em> nếu không có giá trị trả về).</li>
    <li>Nếu một hàm <code>then</code> trả lại một promise thì hàm <code>then</code> tiếp theo sẽ chỉ thực thi khi promise đó được giải quyết (resolve).</li>
    <li>Hàm <code>catch</code> được đặt ở cuối chuỗi sẽ cung cấp một điểm xử lý lỗi duy nhất cho toàn bộ chuỗi.</li>
    <li>Hàm <code>finally</code> ở cuối chuỗi sẽ luôn được thực hiện cho dù promise được giải quyết (resolve) hoặc bị từ chối (reject), để phục vụ mục đích dọn dẹp các promises.</li>
  </ul>
</blockquote>

<h2 id="parallel-promises">Parallel Promises</h2>

<p>Một phương thức chúng ta đề cập tiếp theo đây đó là <code>$q.all()</code>, nó được sử dụng để tạo ra một promise từ một tập các promises. Và promise duy nhất này được giải quyết (resolve) khi tất cả các promises bên trong nó được giải quyết. Trong Angular, phương thức này có thể được gọi bằng 2 cách: với một mảng (Array) hoặc một đối tượng (Object).</p>

<ul>
  <li>Array: </li>
</ul>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$q</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">promiseOne</span><span class="p">,</span> <span class="nx">promiseTwo</span><span class="p">,</span> <span class="nx">promiseThree</span><span class="p">])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">results</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">results</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
  <span class="p">});</span></code></pre></div>

<ul>
  <li>Object:</li>
</ul>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$q</span><span class="p">.</span><span class="nx">all</span><span class="p">({</span> <span class="nx">first</span><span class="o">:</span> <span class="nx">promiseOne</span><span class="p">,</span> <span class="nx">second</span><span class="o">:</span> <span class="nx">promiseTwo</span><span class="p">,</span> <span class="nx">third</span><span class="o">:</span> <span class="nx">promiseThree</span> <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">first</span><span class="p">,</span> <span class="nx">results</span><span class="p">.</span><span class="nx">second</span><span class="p">,</span> <span class="nx">results</span><span class="p">.</span><span class="nx">third</span><span class="p">);</span>
  <span class="p">});</span></code></pre></div>

<p>Bạn có thể tham khảo demo dưới đây. Trong demo này, mặc dù các promise được resolve theo thứ tự three, one, two nhưng khi chúng ta sử dụng <code>$q.all()</code> thì kết quả trả lại sẽ theo thứ tự của các promise trong hàm <em>all()</em> (click vào tab <em>Result</em> để xem kết quả):</p>

<iframe width="100%" height="300" src="http://jsfiddle.net/taly2808/1jnyh630/embedded/js,html,result" allowfullscreen="allowfullscreen" frameborder="0"></iframe>

<p>Thêm một phương thức nữa đó là <code>$q.when()</code> - hàm này hữu ích khi chúng ta đang sử dụng một function mà kết quả trả về có thể là một promise nhưng cũng có thể trả về một giá trị (lúc này chúng ta không cần phải trì hoãn - defer). Chúng ta có thể xem ví dụ dưới đây (bạn click vào tab <em>Result</em> để xem kết quả khi chạy: ban đầu sẽ hiển thị <em>Ready.</em> , 1 giây sau hiển thị <em>noPromise</em>, 3 giây sau hiển thị <em>promise</em>  )</p>

<iframe width="100%" height="300" src="http://jsfiddle.net/taly2808/4q2g3vy7/embedded/js,html,result" allowfullscreen="allowfullscreen" frameborder="0"></iframe>

<h2 id="ti-liu-tham-kho">Tài liệu tham khảo</h2>

<ol>
  <li><a href="http://www.toptal.com/javascript/javascript-promises">JavaScript Promises</a></li>
  <li><a href="http://blog.xebia.com/2014/02/23/promises-and-design-patterns-in-angularjs/">Promises And Design Patterns In AngularJS</a></li>
  <li><a href="http://documentup.com/kriskowal/q">Document about Q</a></li>
  <li><a href="http://blog.mediumequalsmessage.com/promise-deferred-objects-in-javascript-pt1-theory-and-semantics">Promise &amp; Deferred objects in JavaScript Pt.1: Theory and Semantics.</a></li>
  <li><a href="http://www.dwmkerr.com/promises-in-angularjs-the-definitive-guide/">AngularJS Promises - The Definitive Guide</a></li>
</ol>

                        <br>
                        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive_bottom -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9160637159175593"
     data-ad-slot="9145112668"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
                    
                    
                    <div class="entry-tags text-center">
                    
                        <i class="icon-tags"></i>&nbsp;Tagged with <a href="http://thapsang.net/tags/index.html#promise" data-toggle="tooltip" title="Posts tagged with promise" rel="tag">promise</a>&nbsp;&bull;&nbsp;<a href="http://thapsang.net/tags/index.html#angularjs" data-toggle="tooltip" title="Posts tagged with angularjs" rel="tag">angularjs</a>
                    
                    </div>
                    
                    </div>
        </div>
                    <footer class="post-footer entry-meta">
                        <div class="post-share text-center">
    <p class="light small">
        Share this post
    </p>
    <ul class="social-mini">
        <li>
            <a href="https://twitter.com/intent/tweet?text=&quot;Promises/Deferred trong AngularJS&quot;%20http://thapsang.net/angularjs/promises-deferred-trong-angularjs%20via%20&#64;taly2808"
            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" data-toggle="tooltip" title="Share on Twitter" itemprop="Twitter">
                <i class="icon-twitter"></i>
            </a>
        </li>
        <li>
            <a  href="https://www.facebook.com/sharer/sharer.php?u=http://thapsang.net/angularjs/promises-deferred-trong-angularjs"
            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" data-toggle="tooltip" title="Share on Facebook" itemprop="Facebook">
                <i class="icon-facebook"></i>
            </a>
        </li>
        <li>
            <a href="https://plus.google.com/share?url=http://thapsang.net/angularjs/promises-deferred-trong-angularjs"
           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" data-toggle="tooltip" title="Share on Google plus" itemprop="GooglePlus">
                <i class="icon-google-plus"></i>
            </a>
        </li>
    </ul>
</div>
                        <div class="post-author text-center">                       
	        <img src="http://thapsang.net/images/my-ava.png" alt="Ta Ly's photo" itemprop="image" class="post-avatar img-circle img-responsive"/>    
	    <h4 class="bordered-bottom vcard author" itemprop="author" itemscope itemtype="http://schema.org/Person">Written by <span itemprop="name" class="fn"><a href="http://thapsang.net/about" rel="author" title="About Ta Ly" itemprop="url">Ta Ly</a></span></h4>
	    <p>Hãy thắp một ngọn nến nhỏ, thay vì nguyền rủa bóng đêm!</p>
</div>
 
                        <div id="disqus_thread"></div><!-- /#disqus_thread -->
                    </footer>
            </article>
    </div>
</div>

<footer id="footer"  class="blog-background overlay text-center align-middle animated from-top" style="background-image: url(http://thapsang.net/images/picture-2.jpg)" >


    <div class="inner">
        <div class="container">

            <ul class="social-icons">
            <li>
                <a href="http://twitter.com/taly2808" data-toggle="tooltip" title="Ta Ly on Twitter" target="_blank">
                    <i class="icon-twitter"></i>
                </a>
            </li>
            <li>
                <a href="http://facebook.com/taly2808" data-toggle="tooltip" title="Ta Ly on Facebook" target="_blank">
                    <i class="icon-facebook"></i>
                </a>
            </li>
            <li>
                <a href="https://plus.google.com/+TaLy2808" data-toggle="tooltip" title="Ta Ly on Google+" target="_blank">
                    <i class="icon-google-plus"></i>
                </a>
            </li>
            
            <li>
                <a href="taly2808" data-toggle="tooltip" title="Ta Ly on LinkedIn" target="_blank">
                    <i class="icon-linkedin"></i>
                </a>
            </li>
            
            
            <li>
                <a href="http://github.com/taly2808" data-toggle="tooltip" title="Ta Ly on Github" target="_blank">
                    <i class="icon-github"></i>
                </a>
            </li>
        </ul>
            <div>
                Bản quyền nội dung thuộc về <a href="http://thapsang.net/about/">Ta Ly</a> &copy; 2014 &dash; 2015.
            </div>
            <ul class="menu-items">
            
            <li>
                
                    <a href="http://thapsang.net/"><i class="icon-home"></i></a>&nbsp;&bull;
                 
            </li>
            
            <li>
                
                    <a href="http://thapsang.net/categories">Danh mục</a>&nbsp;&bull;
                 
            </li>
            
            <li>
                
                    <a href="http://thapsang.net/tags"><i class="icon-tag"></i> Tags</a>&nbsp;&bull;
                 
            </li>
            
            <li>
                
                    <a href="http://thapsang.net/about">Giới thiệu</a>&nbsp;&bull;
                 
            </li>
            
            <li><a href="https://feedburner.google.com/fb/a/mailverify?uri=thapsangnet/taly2808&amp;loc=en_US" title="Atom/RSS feed" target="_blank"><i class="icon-rss"></i> Feed</a></li>
        </ul>
        </div>
    </div>
    
        <div class="decor-wrapper">
            <svg id="footer-decor" class="decor top" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" preserveAspectRatio="none">

                <path class="large left" d="M0 0 L50 50 L0 100" fill="rgba(255,255,255, .1)"></path>
                <path class="large right" d="M100 0 L50 50 L100 100" fill="rgba(255,255,255, .1)"></path>

                <path class="medium left" d="M0 0 L50 50 L0 66.6" fill="rgba(255,255,255, .3)"></path>
                <path class="medium right" d="M100 0 L50 50 L100 66.6" fill="rgba(255,255,255, .3)"></path>

                <path class="small left" d="M0 0 L50 50 L0 33.3" fill="rgba(255,255,255, .5)"></path>
                <path class="small right" d="M100 0 L50 50 L100 33.3" fill="rgba(255,255,255, .5)"></path>

                <path d="M0 0 L50 50 L100 0 L0 0" fill="rgba(255,255,255, 1)"></path>

                <path d="M48 48 L50 51 L52 48 L48 48" fill="rgba(255,255,255, 1)"></path>

            </svg>
        </div>
    
</footer>


    
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://thapsang.net/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://thapsang.net/assets/js/scripts.min.js"></script>
<script type="text/javascript" src="http://thapsang.net/assets/js/waypoints.min.js"></script>
<script type="text/javascript" src="http://thapsang.net/assets/js/script.js"></script>
<script type='text/javascript'>$(document).ready(function(){$(".time").text(function(a,b){return Math.round(parseFloat(b))})});</script>

<script type="text/javascript">

/*      Slides       */

$("a#slide").click(function(){
    $("#sidebar,body,a#slide,#fade").addClass("slide")
});

$("#fade,#header,#posts-container").click(function(){
    $("#sidebar,body,a#slide,#fade").removeClass("slide")
});

$("a#click-filter").click(function(){
    $("#slide-filter").slideToggle("medium");
    $("#slide-pages").slideOut("medium");
});

$("a#click-pages").click(function(){
    $("#slide-pages").slideToggle("medium");
    $("#slide-filter").slideOut("medium");
});

/*      End-Slides      */

</script>


<!-- Jekyll Simple Search option -->
<script>
  $(document).ready(function() {
      $('.search-field').simpleJekyllSearch({
          jsonFile : 'http://thapsang.net/search.json',
          searchResults : '.search-results',
          template : '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
          noResults: '<p>Nothing found.</p>'
        });
  });

  (function( $, window, undefined ) {
    
     var bs = {
          close: $(".icon-remove-sign"),
          searchform: $(".search-form"),
          canvas: $("body"),
          dothis: $('.dosearch')
      };
    
    bs.dothis.on('click', function() {
      $('.search-wrapper').css({ display: "block" });
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('search-overlay');
    });
    
      bs.close.on('click', function() {
        $('.search-wrapper').removeAttr( 'style' );
        bs.searchform.toggleClass('active');
        bs.canvas.removeClass('search-overlay');
    });
  })( jQuery, window );
</script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55360781-1', 'auto');
  ga('send', 'pageview');

</script>


<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'thapsang'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 
</body>
</html>
